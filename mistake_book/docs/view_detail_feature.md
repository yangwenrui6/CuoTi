# 查看错题详情功能文档

## 📋 功能概述

为错题卡片添加"查看详情"功能，用户可以点击按钮查看错题的完整信息，包括题目内容、答案、解析、复习数据等。

## 🎯 功能目标

1. 在错题卡片上添加"查看"按钮
2. 点击按钮显示详情对话框
3. 详情对话框展示完整的错题信息
4. 支持查看图片（如果有）
5. 显示复习统计数据

## 🏗️ 架构设计

### 分层实现

```
UI层 (detail_dialog.py)
    ↓ 调用
Service层 (question_service.py)
    ↓ 调用
Business层 (data_manager.py)
    ↓ 调用
Data层 (db_manager.py)
```

## 📁 涉及的文件

### 1. 服务层

**文件**: `src/mistake_book/services/question_service.py`

**新增方法**:
```python
def get_question_detail(self, question_id: int) -> tuple[bool, str, Optional[Dict[str, Any]]]:
    """
    获取错题详细信息
    
    Args:
        question_id: 题目ID
    
    Returns:
        (成功标志, 消息, 题目详情)
    """
```

**职责**:
- 调用 data_manager 获取题目数据
- 统一错误处理
- 返回标准格式

### 2. UI层 - 详情对话框

**文件**: `src/mistake_book/ui/dialogs/detail_dialog.py`

**类**: `QuestionDetailDialog`

**功能模块**:
1. **标题栏** - 显示题目ID、科目、题型
2. **基本信息** - 难度、掌握度、标签
3. **题目内容** - 完整题目文本
4. **答案部分** - 我的答案、正确答案、解析
5. **复习数据** - 复习次数、间隔、难度因子、下次复习时间
6. **图片展示** - 如果有图片则显示

**特点**:
- ✅ 滚动区域支持长内容
- ✅ 分组显示，结构清晰
- ✅ 颜色区分不同类型信息
- ✅ 响应式布局

### 3. UI层 - 错题卡片

**文件**: `src/mistake_book/ui/widgets/question_card.py`

**修改**:
- 添加 `view_detail` 信号
- 添加"👁️ 查看"按钮
- 连接按钮点击事件

**按钮样式**:
```python
QPushButton {
    background-color: #3498db;
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 9pt;
    font-weight: bold;
}
```

### 4. UI层 - 主窗口

**文件**: `src/mistake_book/ui/main_window.py`

**新增方法**:
```python
def on_view_detail(self, question):
    """查看详情事件"""
    success, message, detail = self.question_service.get_question_detail(question['id'])
    
    if success and detail:
        dialog = QuestionDetailDialog(detail, self)
        dialog.exec()
```

**修改**:
- 连接卡片的 `view_detail` 信号
- 调用服务获取详情
- 显示详情对话框

## 🎨 界面设计

### 详情对话框布局

```
┌─────────────────────────────────────────────┐
│  📖 错题详情                          [×]   │
├─────────────────────────────────────────────┤
│  ┌───────────────────────────────────────┐ │
│  │ 题目 #123                             │ │
│  │ 数学 · 单选题                         │ │
│  └───────────────────────────────────────┘ │
│                                             │
│  📋 基本信息                                │
│  ┌───────────────────────────────────────┐ │
│  │ 难度: ⭐⭐⭐                           │ │
│  │ 掌握度: 🟡 学习中                     │ │
│  │ 标签: 🏷️ 代数 🏷️ 函数               │ │
│  └───────────────────────────────────────┘ │
│                                             │
│  📝 题目内容                                │
│  ┌───────────────────────────────────────┐ │
│  │ 求函数 f(x)=x²+2x+1 的最小值...       │ │
│  └───────────────────────────────────────┘ │
│                                             │
│  ❌ 我的答案                                │
│  ┌───────────────────────────────────────┐ │
│  │ 1                                     │ │
│  └───────────────────────────────────────┘ │
│                                             │
│  ✅ 正确答案                                │
│  ┌───────────────────────────────────────┐ │
│  │ 0                                     │ │
│  └───────────────────────────────────────┘ │
│                                             │
│  💡 解析                                    │
│  ┌───────────────────────────────────────┐ │
│  │ 配方法: f(x)=(x+1)²，最小值为0        │ │
│  └───────────────────────────────────────┘ │
│                                             │
│  📊 复习数据                                │
│  ┌───────────────────────────────────────┐ │
│  │ 已复习: 3 次                          │ │
│  │ 当前间隔: 6 天                        │ │
│  │ 难度因子: 2.50                        │ │
│  │ 下次复习: 2024-01-20 10:00           │ │
│  │ 创建时间: 2024-01-10 15:30           │ │
│  └───────────────────────────────────────┘ │
│                                             │
│  🖼️ 题目图片                                │
│  ┌───────────────────────────────────────┐ │
│  │         [图片预览]                    │ │
│  └───────────────────────────────────────┘ │
│                                             │
│                              [关闭]         │
└─────────────────────────────────────────────┘
```

### 卡片按钮位置

```
┌─┬────────────────────────────────┬──────────┐
│█│ 📚 数学 • 单选题        ⭐⭐⭐  │ 🟡 学习中│
│█│ 求函数 f(x)=x²+2x+1...         │ 已复习3次│
│█│ 🏷️ 代数 🏷️ 函数              │ [👁️ 查看]│
└─┴────────────────────────────────┴──────────┘
```

## 🔄 交互流程

### 查看详情流程

```
用户点击卡片上的"查看"按钮
    ↓
触发 view_detail 信号
    ↓
MainWindow.on_view_detail()
    ↓
QuestionService.get_question_detail(question_id)
    ↓
DataManager.get_question(question_id)
    ↓
DatabaseManager 查询数据库
    ↓
返回完整题目数据
    ↓
创建 QuestionDetailDialog
    ↓
显示详情对话框
    ↓
用户查看信息
    ↓
点击"关闭"按钮
    ↓
对话框关闭
```

## 💡 设计亮点

### 1. 信息分组
- 使用 QGroupBox 分组显示
- 每个分组有清晰的标题
- 视觉上易于区分

### 2. 颜色编码
- 我的答案：红色背景 (#fadbd8)
- 正确答案：绿色背景 (#d5f4e6)
- 解析：黄色背景 (#fef5e7)
- 基本信息：灰色背景 (#f8f9fa)

### 3. 图标使用
- 📋 基本信息
- 📝 题目内容
- ❌ 我的答案
- ✅ 正确答案
- 💡 解析
- 📊 复习数据
- 🖼️ 题目图片

### 4. 响应式设计
- 使用 QScrollArea 支持长内容
- 自动换行显示长文本
- 图片自动缩放

### 5. 用户体验
- 一键查看完整信息
- 无需离开主界面
- 快速关闭返回

## 🧪 测试要点

### 功能测试
1. ✅ 点击"查看"按钮能正常打开对话框
2. ✅ 对话框显示完整的题目信息
3. ✅ 所有字段正确显示
4. ✅ 图片（如果有）正确加载
5. ✅ 关闭按钮正常工作

### 边界测试
1. ✅ 题目不存在时的错误处理
2. ✅ 图片路径无效时的处理
3. ✅ 长文本的显示和滚动
4. ✅ 空字段的处理（不显示空分组）

### 性能测试
1. ✅ 对话框打开速度
2. ✅ 大图片加载性能
3. ✅ 长文本渲染性能

## 📊 数据流

### 获取详情数据

```python
# 1. UI层调用
success, message, detail = self.question_service.get_question_detail(question_id)

# 2. Service层处理
def get_question_detail(self, question_id):
    question = self.data_manager.get_question(question_id)
    if question:
        return True, "获取成功", question
    else:
        return False, "题目不存在", None

# 3. 返回的数据结构
detail = {
    'id': 123,
    'subject': '数学',
    'question_type': '单选题',
    'content': '题目内容...',
    'my_answer': '我的答案',
    'answer': '正确答案',
    'explanation': '解析',
    'difficulty': 3,
    'mastery_level': 1,
    'repetitions': 3,
    'interval': 6,
    'easiness_factor': 2.5,
    'next_review_date': datetime(...),
    'created_at': datetime(...),
    'image_path': '/path/to/image.png',
    'tags': ['代数', '函数']
}
```

## 🔧 扩展建议

### 未来可以添加的功能

1. **编辑功能**
   - 在详情对话框添加"编辑"按钮
   - 点击后打开编辑对话框

2. **删除功能**
   - 添加"删除"按钮
   - 确认后删除题目

3. **分享功能**
   - 导出单个题目为图片
   - 复制题目内容到剪贴板

4. **打印功能**
   - 打印题目详情
   - 生成PDF

5. **历史记录**
   - 显示所有复习记录
   - 复习趋势图表

## 📚 相关文档

- [服务层重构](refactoring_services.md) - 服务层架构
- [GUI设计](gui_design.md) - 界面设计规范
- [前后端集成](integration.md) - 集成说明
- [数据库设计](database_design.md) - 数据结构

## 🎉 总结

通过添加查看详情功能，用户可以：
- ✅ 快速查看错题完整信息
- ✅ 了解复习进度和数据
- ✅ 查看题目图片
- ✅ 更好地理解和学习错题

功能实现遵循了项目的分层架构，代码清晰易维护！

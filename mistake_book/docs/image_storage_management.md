# å›¾ç‰‡å­˜å‚¨ç®¡ç†åŠŸèƒ½

## ğŸ“… å®ç°æ—¶é—´
2026å¹´2æœˆ4æ—¥

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

ä¸ºé¢˜ç›®å›¾ç‰‡å»ºç«‹ä¸“é—¨çš„å­˜å‚¨æ–‡ä»¶å¤¹ï¼Œç»Ÿä¸€ç®¡ç†æ‰€æœ‰é¢˜ç›®çš„å›¾ç‰‡èµ„æºï¼Œé¿å…å›¾ç‰‡æ•£è½åœ¨å„å¤„ï¼Œä¾¿äºå¤‡ä»½å’Œè¿ç§»ã€‚

## ğŸ“ å­˜å‚¨ç»“æ„

### å›¾ç‰‡å­˜å‚¨ç›®å½•
```
ç”¨æˆ·æ•°æ®ç›®å½•/
â””â”€â”€ images/
    â”œâ”€â”€ 20260204_143022_math_question.png
    â”œâ”€â”€ 20260204_143156_physics_problem.jpg
    â””â”€â”€ ...
```

### ç›®å½•ä½ç½®
- **Windows**: `C:\Users\<ç”¨æˆ·å>\AppData\Local\MistakeBook\images\`
- **macOS**: `~/Library/Application Support/MistakeBook/images/`
- **Linux**: `~/.local/share/MistakeBook/images/`

## ğŸ”§ å®ç°ç»†èŠ‚

### 1. è·¯å¾„é…ç½® (paths.py)

æ·»åŠ äº† `images_dir` å±æ€§ï¼š

```python
@property
def images_dir(self) -> Path:
    """é¢˜ç›®å›¾ç‰‡å­˜å‚¨ç›®å½•"""
    images = self.data_dir / "images"
    images.mkdir(exist_ok=True)
    return images
```

### 2. å›¾ç‰‡å¤åˆ¶åŠŸèƒ½ (question_service.py)

#### æ ¸å¿ƒæ–¹æ³•

**_copy_image_to_storage()**
- å°†ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡å¤åˆ¶åˆ°åº”ç”¨çš„imagesç›®å½•
- ç”Ÿæˆå”¯ä¸€æ–‡ä»¶åï¼š`æ—¶é—´æˆ³_åŸæ–‡ä»¶å`
- è¿”å›ç›¸å¯¹è·¯å¾„ï¼ˆä»…æ–‡ä»¶åï¼‰

**get_image_full_path()**
- æ ¹æ®ç›¸å¯¹è·¯å¾„è·å–å®Œæ•´è·¯å¾„
- å…¼å®¹æ—§æ•°æ®çš„ç»å¯¹è·¯å¾„
- æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨

#### æ–‡ä»¶å‘½åè§„åˆ™

```
æ ¼å¼: YYYYMMDD_HHMMSS_åŸæ–‡ä»¶å
ç¤ºä¾‹: 20260204_143022_question_image.png
```

ä¼˜ç‚¹ï¼š
- æ—¶é—´æˆ³ç¡®ä¿å”¯ä¸€æ€§
- ä¿ç•™åŸæ–‡ä»¶åä¾¿äºè¯†åˆ«
- æŒ‰æ—¶é—´æ’åºæ–¹ä¾¿ç®¡ç†

### 3. æ•°æ®åº“å­˜å‚¨

#### å­˜å‚¨æ ¼å¼
- **æ–°æ•°æ®**: å­˜å‚¨ç›¸å¯¹è·¯å¾„ï¼ˆæ–‡ä»¶åï¼‰
  ```
  image_path: "20260204_143022_math_question.png"
  ```

- **æ—§æ•°æ®**: ä¿æŒç»å¯¹è·¯å¾„ï¼ˆå…¼å®¹æ€§ï¼‰
  ```
  image_path: "C:\Users\...\image.png"
  ```

#### å…¼å®¹æ€§å¤„ç†
`get_image_full_path()` æ–¹æ³•è‡ªåŠ¨è¯†åˆ«ï¼š
- å¦‚æœæ˜¯ç»å¯¹è·¯å¾„ï¼Œç›´æ¥ä½¿ç”¨
- å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œæ‹¼æ¥images_dir

### 4. å›¾ç‰‡åŠ è½½ (detail_dialog.py)

æ›´æ–°äº†å›¾ç‰‡æ˜¾ç¤ºé€»è¾‘ï¼š

```python
# è·å–å®Œæ•´è·¯å¾„
if self.question_service:
    full_path = self.question_service.get_image_full_path(image_path_str)
else:
    # å…¼å®¹æ—§ä»£ç 
    full_path = Path(image_path_str) if Path(image_path_str).exists() else None

# ä½¿ç”¨PILåŠ è½½ï¼Œé¿å…ä¸­æ–‡è·¯å¾„é—®é¢˜
if full_path and full_path.exists():
    pil_image = Image.open(full_path)
    # ... è½¬æ¢ä¸ºQPixmapæ˜¾ç¤º
```

## ğŸ“Š å·¥ä½œæµç¨‹

### æ·»åŠ é¢˜ç›®æ—¶

```
1. ç”¨æˆ·æ‹–æ‹½/é€‰æ‹©å›¾ç‰‡
   â†“
2. å›¾ç‰‡è·¯å¾„ä¼ é€’ç»™question_service
   â†“
3. _copy_image_to_storage() å¤åˆ¶å›¾ç‰‡
   â†“
4. ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
   â†“
5. ä¿å­˜åˆ° images/ ç›®å½•
   â†“
6. æ•°æ®åº“å­˜å‚¨ç›¸å¯¹è·¯å¾„
```

### æ˜¾ç¤ºå›¾ç‰‡æ—¶

```
1. ä»æ•°æ®åº“è¯»å– image_path
   â†“
2. get_image_full_path() è·å–å®Œæ•´è·¯å¾„
   â†“
3. æ£€æŸ¥è·¯å¾„ç±»å‹ï¼ˆç»å¯¹/ç›¸å¯¹ï¼‰
   â†“
4. æ‹¼æ¥å®Œæ•´è·¯å¾„
   â†“
5. ä½¿ç”¨PILåŠ è½½å›¾ç‰‡
   â†“
6. æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Š
```

## âœ… ä¼˜åŠ¿

### 1. é›†ä¸­ç®¡ç†
- æ‰€æœ‰å›¾ç‰‡ç»Ÿä¸€å­˜å‚¨åœ¨ä¸€ä¸ªç›®å½•
- ä¾¿äºæŸ¥çœ‹å’Œç®¡ç†
- é¿å…å›¾ç‰‡æ•£è½å„å¤„

### 2. ä¾¿äºå¤‡ä»½
- åªéœ€å¤‡ä»½ images/ ç›®å½•
- é…åˆæ•°æ®åº“å¤‡ä»½ï¼Œå®Œæ•´è¿ç§»æ•°æ®
- æ”¯æŒäº‘åŒæ­¥

### 3. é¿å…è·¯å¾„é—®é¢˜
- ä¸ä¾èµ–åŸå›¾ç‰‡ä½ç½®
- åŸå›¾ç‰‡åˆ é™¤ä¸å½±å“é¢˜ç›®
- æ”¯æŒä¸­æ–‡è·¯å¾„

### 4. å…¼å®¹æ€§å¥½
- è‡ªåŠ¨è¯†åˆ«æ–°æ—§æ•°æ®æ ¼å¼
- æ—§æ•°æ®ç»§ç»­å¯ç”¨
- å¹³æ»‘å‡çº§

### 5. æ˜“äºæ¸…ç†
- å¯ä»¥æ‰¹é‡ç®¡ç†å›¾ç‰‡
- åˆ é™¤é¢˜ç›®æ—¶å¯é€‰æ‹©åˆ é™¤å›¾ç‰‡
- å®šæœŸæ¸…ç†æœªä½¿ç”¨çš„å›¾ç‰‡

## ğŸ”„ æ•°æ®è¿ç§»

### æ—§æ•°æ®å…¼å®¹

ç°æœ‰é¢˜ç›®çš„å›¾ç‰‡è·¯å¾„ï¼ˆç»å¯¹è·¯å¾„ï¼‰ç»§ç»­å¯ç”¨ï¼š
- `get_image_full_path()` è‡ªåŠ¨è¯†åˆ«
- ä¸éœ€è¦æ‰‹åŠ¨è¿ç§»
- æ–°æ·»åŠ çš„é¢˜ç›®ä½¿ç”¨æ–°æ ¼å¼

### å¯é€‰è¿ç§»è„šæœ¬

å¦‚æœéœ€è¦å°†æ—§å›¾ç‰‡è¿ç§»åˆ°æ–°ç›®å½•ï¼š

```python
# scripts/migrate_images.py
def migrate_old_images():
    """å°†æ—§çš„ç»å¯¹è·¯å¾„å›¾ç‰‡è¿ç§»åˆ°imagesç›®å½•"""
    questions = data_manager.get_all_questions()
    
    for q in questions:
        if q.image_path and Path(q.image_path).is_absolute():
            # å¤åˆ¶åˆ°æ–°ç›®å½•
            new_path = copy_image_to_storage(q.image_path)
            if new_path:
                # æ›´æ–°æ•°æ®åº“
                update_question(q.id, {'image_path': new_path})
```

## ğŸ› ï¸ ç»´æŠ¤å»ºè®®

### å®šæœŸæ¸…ç†

åˆ›å»ºæ¸…ç†è„šæœ¬ï¼Œåˆ é™¤æœªè¢«å¼•ç”¨çš„å›¾ç‰‡ï¼š

```python
# scripts/clean_unused_images.py
def clean_unused_images():
    """æ¸…ç†æœªè¢«é¢˜ç›®å¼•ç”¨çš„å›¾ç‰‡"""
    # è·å–æ‰€æœ‰é¢˜ç›®çš„å›¾ç‰‡è·¯å¾„
    used_images = set()
    for q in get_all_questions():
        if q.image_path:
            used_images.add(q.image_path)
    
    # æ‰«æimagesç›®å½•
    for img in images_dir.iterdir():
        if img.name not in used_images:
            # æœªè¢«å¼•ç”¨ï¼Œå¯ä»¥åˆ é™¤
            img.unlink()
```

### å¤‡ä»½ç­–ç•¥

```bash
# å¤‡ä»½æ•°æ®å’Œå›¾ç‰‡
backup_dir="backups/$(date +%Y%m%d)"
mkdir -p "$backup_dir"

# å¤‡ä»½æ•°æ®åº“
cp mistakes.db "$backup_dir/"

# å¤‡ä»½å›¾ç‰‡
cp -r images/ "$backup_dir/"
```

## ğŸ“ ä»£ç ä¿®æ”¹æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶

1. **src/mistake_book/config/paths.py**
   - æ·»åŠ  `images_dir` å±æ€§

2. **src/mistake_book/services/question_service.py**
   - æ·»åŠ  `_copy_image_to_storage()` æ–¹æ³•
   - æ·»åŠ  `get_image_full_path()` æ–¹æ³•
   - ä¿®æ”¹ `create_question()` å¤„ç†å›¾ç‰‡å¤åˆ¶

3. **src/mistake_book/ui/dialogs/detail_dialog.py**
   - ä¿®æ”¹æ„é€ å‡½æ•°ï¼Œæ¥æ”¶ `question_service`
   - æ›´æ–° `add_image_section()` ä½¿ç”¨æ–°çš„å›¾ç‰‡åŠ è½½é€»è¾‘

4. **src/mistake_book/ui/main_window.py**
   - ä¿®æ”¹åˆ›å»º `QuestionDetailDialog` æ—¶ä¼ å…¥ `question_service`

## ğŸ§ª æµ‹è¯•å»ºè®®

### æµ‹è¯•ç”¨ä¾‹

1. **æ–°å¢é¢˜ç›®æµ‹è¯•**
   - æ·»åŠ å¸¦å›¾ç‰‡çš„é¢˜ç›®
   - éªŒè¯å›¾ç‰‡è¢«å¤åˆ¶åˆ°imagesç›®å½•
   - éªŒè¯æ•°æ®åº“å­˜å‚¨ç›¸å¯¹è·¯å¾„
   - éªŒè¯è¯¦æƒ…é¡µæ­£ç¡®æ˜¾ç¤ºå›¾ç‰‡

2. **æ—§æ•°æ®å…¼å®¹æµ‹è¯•**
   - ä½¿ç”¨ç»å¯¹è·¯å¾„çš„æ—§é¢˜ç›®
   - éªŒè¯å›¾ç‰‡ä»èƒ½æ­£å¸¸æ˜¾ç¤º
   - éªŒè¯ä¸å½±å“ç°æœ‰åŠŸèƒ½

3. **ä¸­æ–‡è·¯å¾„æµ‹è¯•**
   - ä¸Šä¼ ä¸­æ–‡æ–‡ä»¶åçš„å›¾ç‰‡
   - éªŒè¯å¤åˆ¶å’Œæ˜¾ç¤ºæ­£å¸¸

4. **è¾¹ç•Œæƒ…å†µæµ‹è¯•**
   - å›¾ç‰‡ä¸å­˜åœ¨
   - å›¾ç‰‡è·¯å¾„ä¸ºç©º
   - å›¾ç‰‡æ ¼å¼ä¸æ”¯æŒ

## ğŸš€ æœªæ¥æ”¹è¿›

### å¯é€‰åŠŸèƒ½

1. **å›¾ç‰‡å‹ç¼©**
   - è‡ªåŠ¨å‹ç¼©å¤§å›¾ç‰‡
   - èŠ‚çœå­˜å‚¨ç©ºé—´
   - æé«˜åŠ è½½é€Ÿåº¦

2. **ç¼©ç•¥å›¾ç”Ÿæˆ**
   - ç”Ÿæˆç¼©ç•¥å›¾ç”¨äºåˆ—è¡¨æ˜¾ç¤º
   - åŸå›¾ç”¨äºè¯¦æƒ…æŸ¥çœ‹
   - æå‡æ€§èƒ½

3. **å›¾ç‰‡ç¼–è¾‘**
   - è£å‰ªã€æ—‹è½¬
   - æ ‡æ³¨ã€é«˜äº®
   - ç›´æ¥åœ¨åº”ç”¨å†…ç¼–è¾‘

4. **æ‰¹é‡å¯¼å…¥**
   - æ‰¹é‡å¯¼å…¥å›¾ç‰‡
   - è‡ªåŠ¨OCRè¯†åˆ«
   - å¿«é€Ÿå»ºç«‹é¢˜åº“

5. **äº‘å­˜å‚¨æ”¯æŒ**
   - ä¸Šä¼ åˆ°äº‘ç«¯
   - å¤šè®¾å¤‡åŒæ­¥
   - èŠ‚çœæœ¬åœ°ç©ºé—´

## ğŸ“ ç›¸å…³æ–‡æ¡£

- [å›¾ç‰‡ä¸Šä¼ å’Œé¢„è§ˆ](image_upload_and_preview.md)
- [ä¸­æ–‡è·¯å¾„ä¿®å¤](chinese_path_fix.md)
- [OCRå®ç°](ocr_implementation.md)
- [æ•°æ®åº“è®¾è®¡](database_design.md)

---

**å®ç°è€…**: Kiro AI Assistant  
**æœ€åæ›´æ–°**: 2026å¹´2æœˆ4æ—¥

# 详情对话框答案编辑功能

## 功能描述
在查看错题详情时，用户可以直接编辑题目内容、我的答案、正确答案和解析内容，退出时如果有修改会提示是否保存。

## 需求背景
用户在查看错题详情时，可能需要：
1. 修正或完善题目内容
2. 修正之前输入的错误答案
3. 补充或修改正确答案
4. 添加或完善解析内容

之前的详情对话框只能查看，无法编辑，用户需要返回列表重新打开编辑对话框，操作繁琐。

## 实现方案

### 1. UI改造
将原来的只读QLabel控件改为可编辑的QTextEdit控件：

#### 题目内容编辑框
- 使用QTextEdit替代QLabel
- 白色背景（#ffffff），深灰色文字（#212121）
- 获得焦点时背景变为浅灰色（#f8f9fa），边框变为蓝色（#3498db）
- 最小高度100px
- 字体14pt，字重500

#### 我的答案编辑框
- 使用QTextEdit替代QLabel
- 保持红色主题（#ffebee背景，#c62828文字）
- 获得焦点时背景变为白色，边框加深
- 最小高度80px
- 字体13pt，字重500

#### 正确答案编辑框
- 使用QTextEdit替代QLabel
- 保持绿色主题（#e8f5e9背景，#2e7d32文字）
- 获得焦点时背景变为白色，边框加深
- 最小高度80px
- 字体13pt，字重600（加粗）

#### 解析编辑框
- 使用QTextEdit替代QLabel
- 保持黄色主题（#fff8e1背景，#f57c00文字）
- 获得焦点时背景变为白色，边框加深
- 最小高度80px
- 字体12pt

### 2. 修改检测机制
- 在对话框初始化时保存原始数据副本（`original_data`）
- 实现`has_changes()`方法比较当前内容与原始数据
- 比较四个字段：content, my_answer, answer, explanation
- 比较时去除首尾空格，避免误判

### 3. 保存功能
添加"💾 保存修改"按钮：
- 检查是否有修改，无修改时提示用户
- 收集修改的数据（content, my_answer, answer, explanation）
- 通过PyQt信号`answer_updated`发送到主窗口
- 保存成功后更新原始数据，避免重复提示
- 显示保存成功消息

### 4. 退出确认
实现两种退出方式的确认：

#### 点击关闭按钮
- 调用`close_dialog()`方法
- 检查是否有未保存的修改
- 如有修改，弹出确认对话框：
  - **保存**：保存修改并关闭
  - **放弃**：不保存直接关闭
  - **取消**：保持对话框打开

#### 点击窗口X按钮
- 重写`closeEvent()`方法
- 同样的确认流程
- 根据用户选择决定是否关闭窗口

### 5. 信号与槽机制
定义信号：
```python
answer_updated = pyqtSignal(int, dict)  # question_id, updates
```

在主窗口中连接：
```python
dialog.answer_updated.connect(self.on_answer_updated)
```

主窗口处理：
```python
def on_answer_updated(self, question_id: int, updates: dict):
    # 调用question_service更新数据
    # 刷新当前视图
    # 显示错误（如果有）
```

## 修改文件

### 1. detail_dialog.py
- 导入QTextEdit和QMessageBox
- 添加`answer_updated`信号
- 添加`original_data`属性保存原始数据
- 添加可编辑控件的引用（content_edit, my_answer_edit等）
- 修改`add_content_section()`使用QTextEdit
- 修改`add_answer_section()`使用QTextEdit
- 添加`has_changes()`方法检测修改（包含content字段）
- 添加`save_changes()`方法保存修改（包含content字段）
- 修改`add_buttons()`添加保存按钮
- 添加`close_dialog()`方法处理关闭
- 重写`closeEvent()`处理窗口关闭

### 2. main_window.py
- 修改`on_view_detail()`连接信号
- 添加`on_answer_updated()`处理更新
- 调用`question_service.update_question()`保存
- 刷新当前视图显示最新数据

## 用户体验优化

### 1. 视觉反馈
- 编辑框获得焦点时背景和边框变化
- 明确标注"(可编辑)"提示用户
- 保存按钮使用绿色，易于识别
- 题目内容获得焦点时边框变蓝色，突出重要性

### 2. 防止数据丢失
- 退出时自动检测未保存的修改
- 提供三个选项：保存、放弃、取消
- 默认选项为"保存"，保护用户数据

### 3. 操作便捷
- 可以随时点击保存按钮
- 保存后继续编辑不会重复提示
- 无修改时关闭不会弹出确认框
- 所有重要字段都可编辑，无需切换界面

### 4. 错误处理
- 保存失败时显示错误消息
- 不会因为保存失败而丢失编辑内容
- 用户可以修改后重新保存

## 技术要点

### 1. QTextEdit vs QLabel
- QTextEdit支持多行编辑和滚动
- 可以设置样式保持视觉一致性
- 支持富文本但我们使用纯文本模式

### 2. 信号槽通信
- 使用PyQt信号实现对话框与主窗口通信
- 解耦对话框和数据层，保持架构清晰
- 主窗口负责实际的数据保存操作

### 3. 事件处理
- closeEvent处理窗口关闭按钮
- close_dialog处理自定义关闭按钮
- 两者逻辑一致，确保用户体验统一

### 4. 数据比较
- 使用strip()去除空格避免误判
- 比较四个字段的任意修改
- 保存后更新原始数据避免重复提示

## 可编辑字段列表

1. **题目内容** (content) - 最重要的字段
2. **我的答案** (my_answer) - 记录错误答案
3. **正确答案** (answer) - 标准答案
4. **解析** (explanation) - 详细解释

## 测试建议

### 功能测试
1. 打开详情对话框，修改题目内容，点击保存
2. 修改答案后点击关闭，验证提示对话框
3. 修改后点击X按钮，验证提示对话框
4. 保存后再关闭，验证不会提示
5. 不修改直接关闭，验证不会提示
6. 同时修改多个字段，验证都能保存

### 边界测试
1. 只修改空格，验证是否正确判断
2. 清空内容后保存，验证是否正常
3. 输入大量文本，验证滚动和显示
4. 保存失败场景，验证错误处理

### UI测试
1. 验证编辑框获得焦点时的样式变化
2. 验证保存按钮的颜色和位置
3. 验证确认对话框的按钮和默认选项
4. 验证成功消息的显示
5. 验证题目内容编辑框的蓝色焦点边框

## 后续优化建议

1. **撤销/重做功能**：QTextEdit内置支持Ctrl+Z
2. **自动保存**：定时保存草稿，防止意外关闭
3. **修改标记**：在标题栏显示*表示有未保存修改
4. **快捷键**：Ctrl+S保存，Esc关闭
5. **历史记录**：记录修改历史，支持回退
6. **字段验证**：确保题目内容不为空

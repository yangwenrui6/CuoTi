# 图片上传和预览功能

## 功能概述

在添加错题对话框中，除了原有的拖拽图片功能，新增了：
1. **点击上传图片**：点击区域或按钮选择图片文件
2. **图片预览**：在对话框中预览上传的图片
3. **查看大图**：点击按钮查看完整尺寸的图片

## 功能特点

### 1. 多种上传方式

#### 方式一：拖拽上传（原有功能）
- 拖拽图片文件到上传区域
- 自动加载图片并触发OCR识别

#### 方式二：点击上传（新增）
- 点击上传区域任意位置
- 或点击"📁 选择图片"按钮
- 打开文件选择对话框
- 选择图片后自动加载并触发OCR识别

### 2. 图片预览

- **缩略图显示**：在对话框中显示图片缩略图（最大400×280）
- **保持比例**：自动保持图片宽高比
- **平滑缩放**：使用高质量缩放算法
- **白色背景**：图片显示在白色背景上，边框清晰

### 3. 查看大图

- **查看按钮**：上传图片后显示"🔍 查看大图"按钮
- **独立窗口**：在新窗口中查看完整图片
- **滚动查看**：大图片可以滚动查看
- **文件信息**：显示文件名、尺寸、大小

## 用户界面

### 上传区域布局

```
┌─────────────────────────────────────┐
│  📸 拖拽图片到此处                    │
│     或点击上传图片                    │
│     自动识别文字到题目内容             │
│                                     │
│     [📁 选择图片]                    │
│                                     │
│  ┌─────────────────────────────┐   │
│  │                             │   │
│  │      图片预览区域             │   │
│  │                             │   │
│  └─────────────────────────────┘   │
│                                     │
│     [🔍 查看大图]                    │
└─────────────────────────────────────┘
```

### 图片查看器窗口

```
┌─────────────────────────────────────┐
│  查看图片                      [×]   │
├─────────────────────────────────────┤
│                                     │
│                                     │
│         完整图片显示区域              │
│         （可滚动）                   │
│                                     │
│                                     │
├─────────────────────────────────────┤
│ 📁 文件名.png | 📏 1920×1080 | 💾 256KB │
│                          [关闭]     │
└─────────────────────────────────────┘
```

## 技术实现

### 1. DropZoneWidget 增强

#### 新增属性
```python
self.upload_btn: QPushButton  # 上传按钮
self.view_btn: QPushButton    # 查看大图按钮
self.current_image_path: str  # 当前图片路径
```

#### 新增方法
```python
def select_image(self):
    """选择图片文件"""
    # 打开文件选择对话框
    # 支持 png, jpg, jpeg, bmp, gif

def mousePressEvent(self, event):
    """点击区域触发上传"""
    # 点击空白区域时打开文件选择

def view_full_image(self):
    """查看完整图片"""
    # 打开图片查看器对话框
```

### 2. ImageViewerDialog 图片查看器

#### 功能
- 显示完整尺寸的图片
- 自动限制最大尺寸（1200×900）
- 保持图片宽高比
- 显示文件信息（文件名、尺寸、大小）
- 支持滚动查看大图片

#### 关键代码
```python
class ImageViewerDialog(QDialog):
    def __init__(self, image_path: str, parent=None):
        # 初始化对话框
        
    def load_image(self):
        # 加载图片
        # 限制最大尺寸
        # 显示文件信息
```

## 使用流程

### 流程1：点击上传

```
1. 打开添加错题对话框
   ↓
2. 点击上传区域或"选择图片"按钮
   ↓
3. 在文件选择对话框中选择图片
   ↓
4. 图片自动加载并显示预览
   ↓
5. 自动触发OCR识别
   ↓
6. 识别结果填充到题目内容
```

### 流程2：查看大图

```
1. 上传图片后
   ↓
2. 点击"🔍 查看大图"按钮
   ↓
3. 打开图片查看器窗口
   ↓
4. 查看完整图片
   ↓
5. 关闭窗口返回
```

## 支持的图片格式

- **PNG** (.png)
- **JPEG** (.jpg, .jpeg)
- **BMP** (.bmp)
- **GIF** (.gif)

## 图片尺寸处理

### 预览区域
- **最大宽度**：400px
- **最大高度**：280px
- **缩放模式**：保持宽高比
- **质量**：平滑缩放（SmoothTransformation）

### 查看器窗口
- **最大宽度**：1200px
- **最大高度**：900px
- **缩放模式**：保持宽高比
- **滚动**：超出窗口大小时可滚动

## 样式设计

### 上传区域
- **边框**：3px 虚线，蓝色 (#3498db)
- **背景**：浅灰色 (#ecf0f1)
- **悬停**：深灰色 (#d5dbdb)
- **圆角**：10px

### 上传按钮
- **背景**：蓝色 (#3498db)
- **文字**：白色
- **悬停**：深蓝色 (#2980b9)
- **圆角**：5px
- **内边距**：10px 20px

### 图片预览
- **边框**：1px 实线，灰色 (#bdc3c7)
- **背景**：白色
- **最大高度**：300px

### 查看器窗口
- **背景**：深色 (#2c3e50)
- **最小尺寸**：800×600

## 用户体验优化

### 1. 交互反馈
- ✅ 上传区域悬停时显示手型光标
- ✅ 上传后按钮文字变为"更换图片"
- ✅ 显示图片加载状态（"✅ 图片已加载"）
- ✅ 查看大图按钮仅在有图片时显示

### 2. 文件信息
- 📁 文件名
- 📏 图片尺寸（宽×高）
- 💾 文件大小（KB）

### 3. 错误处理
- 无法加载图片时显示错误提示
- 文件格式不支持时过滤掉
- 加载失败时显示友好提示

## 代码结构

### 新增文件

```
src/mistake_book/ui/dialogs/
├── add_dialog.py          # 修改：增强DropZoneWidget
└── image_viewer.py        # 新增：图片查看器对话框
```

### 修改文件

```
src/mistake_book/ui/dialogs/add_dialog.py
├── DropZoneWidget
│   ├── + upload_btn: QPushButton
│   ├── + view_btn: QPushButton
│   ├── + current_image_path: str
│   ├── + select_image()
│   ├── + mousePressEvent()
│   └── + view_full_image()
└── AddQuestionDialog
    └── (无修改)
```

## 测试要点

### 功能测试
- [ ] 点击上传区域可以选择图片
- [ ] 点击"选择图片"按钮可以选择图片
- [ ] 拖拽图片到区域可以上传
- [ ] 上传后显示图片预览
- [ ] 上传后自动触发OCR识别
- [ ] 点击"查看大图"可以查看完整图片
- [ ] 查看器显示正确的文件信息
- [ ] 大图片可以滚动查看

### 兼容性测试
- [ ] 支持 PNG 格式
- [ ] 支持 JPEG 格式
- [ ] 支持 BMP 格式
- [ ] 支持 GIF 格式
- [ ] 中文路径图片可以正常加载
- [ ] 大尺寸图片正确缩放

### 用户体验测试
- [ ] 上传区域悬停效果正常
- [ ] 按钮状态切换正确
- [ ] 图片预览清晰
- [ ] 查看器窗口大小合适
- [ ] 文件信息显示准确

## 常见问题

### Q: 支持哪些图片格式？

A: 支持 PNG、JPEG、BMP、GIF 格式。

### Q: 图片太大会怎样？

A: 
- 预览区域：自动缩放到 400×280
- 查看器：自动缩放到 1200×900
- 超出窗口大小时可以滚动查看

### Q: 可以更换图片吗？

A: 可以！上传图片后，按钮文字变为"更换图片"，点击可以重新选择。

### Q: 查看大图时可以缩放吗？

A: 当前版本显示固定大小，超出窗口时可以滚动查看。将来可以添加缩放功能。

### Q: 中文路径的图片可以上传吗？

A: 可以！已经解决了中文路径问题，参见 `chinese_path_fix.md`。

## 未来改进

### 可能的增强功能
1. **图片编辑**：裁剪、旋转、调整亮度
2. **缩放控制**：在查看器中放大/缩小
3. **多图上传**：支持一次上传多张图片
4. **图片管理**：查看历史上传的图片
5. **拖拽排序**：多图时可以调整顺序

## 相关文档

- `ocr_implementation.md` - OCR功能实现
- `auto_ocr_on_drop.md` - 拖拽自动OCR
- `chinese_path_fix.md` - 中文路径修复

---

**功能状态：** ✅ 已实现  
**添加日期：** 2026-02-04  
**版本：** 1.0
